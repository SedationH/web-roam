## 来源

https://juejin.cn/post/6949370458793836580 1 

https://juejin.cn/post/6950084496515399717#heading-3 2

## 构建文件分类

### 构建文件分类

|                               | UMD                | CommonJS                   | ES Module          |
| ----------------------------- | ------------------ | -------------------------- | ------------------ |
| **Full**                      | vue.js             | vue.common.js              | vue.esm.js         |
| **Runtime-only**              | vue.runtime.js     | vue.runtime.common.js      | vue.runtime.esm.js |
| **Full (production)**         | vue.min.js         | vue.common.prod.js         |                    |
| **Runtime-only (production)** | vue.runtime.min.js | vue.runtime.common.prod.js |                    |

### 名词解释

- **Full**：这是一个全量的包，包含编译器（`compiler`）和运行时（`runtime`）。
- **Compiler**：编译器，负责将模版字符串（即你编写的类 html 语法的模版代码）编译为 JavaScript 语法的 render 函数。
- **Runtime**：负责创建 Vue 实例、渲染函数、patch 虚拟 DOM 等代码，基本上除了编译器之外的代码都属于运行时代码。
- **UMD**：兼容 CommonJS 和 AMD 规范，通过 CDN 引入的 vue.js 就是 UMD 规范的代码，包含编译器和运行时。
- **CommonJS**：典型的应用比如 nodeJS，CommonsJS 规范的包是为了给 browserify 和 webpack 1 这样旧的打包器使用的。他们默认的入口文件为 `vue.runtime.common.js`。
- **ES Module**：现代 JavaScript 规范，ES Module 规范的包是给像 webpack 2 和 rollup 这样的现代打包器使用的。这些打包器默认使用仅包含运行时的 `vue.runtime.esm.js` 文件。



## 寻找Vue的初始化入口文件

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Vue 源码解读</title>
</head>

<body>
  <div id="app">
    {{ msg }}
  </div>
  <script src="../../dist/vue.js"></script>
  <script>
    debugger
    new Vue({
      el: '#app',
      data: {
        msg: 'hello vue'
      }
    })
  </script>
</body>

</html>
```



serve 整个项目后 可以快速定位到入口

![image-20210715153957567](http://picbed.sedationh.cn/image-20210715153957567.png)



下面开始从入口研究Vue流程、添加注释并去除一些无关代码



## Vue入口函数

/src/core/instance/index.js

```js
function Vue(options) {
  // if (process.env.NODE_ENV !== 'production' &&
  //   !(this instanceof Vue)
  // ) {
  //   warn('Vue is a constructor and should be called with the `new` keyword')
  // }

  // 调用 Vue.prototype._init 方法，该方法是在 initMixin 中定义的
  this._init(options);
}

// 提供 Vue.prototype._init 方法
initMixin(Vue);

export default Vue;
```



## 初始化内容

```js
Vue.prototype._init = function (options?: Object) {
  // vue 实例
  const vm: Component = this
  // a uid
  // 每个Vue实例都有一个uid 并且这个是自增的
  vm._uid = uid++

  // 进行性能测试
  // let startTag, endTag
  // /* istanbul ignore if */
  // if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
  //   startTag = `vue-perf-start:${vm._uid}`
  //   endTag = `vue-perf-end:${vm._uid}`
  //   mark(startTag)
  // }

  // a flag to avoid this being observed
  // 如果是vue实例这样的对象，是不需要进行 observed 的
  vm._isVue = true
  // merge options
  if (options && options._isComponent) {
    // 这里的优化是减少在原型链上的查询
    // optimize internal component instantiation
    // since dynamic options merging is pretty slow, and none of the
    // internal component options needs special treatment.
    initInternalComponent(vm, options)
  } else {
    // 初始化根组件
    // 合并Vue中的全局配置 如 Vue.component()
    vm.$options = mergeOptions(
      resolveConstructorOptions(vm.constructor),
      options || {},
      vm
    )
  }
  /* istanbul ignore else */
  if (process.env.NODE_ENV !== 'production') {
    initProxy(vm)
  } else {
    vm._renderProxy = vm
  }
  // expose real self
  vm._self = vm
  // 初始化组件实例关系属性 如 $parent $children $root $refs
  initLifecycle(vm)
  // 初始化自定义事件
  // <comp @click="handleClick"></comp>
  // 谁触发 谁监听 -> 子组件自行维护触发和监听行为
  // 看模版编译后的结果 在comp 这个组件实例中
  // 有 this.on('click'，fn) this.emit('click') 的代码
  initEvents(vm)
  // 初始化插槽 获取 this.$slots 定义 this._c -> createElemet -> h函数
  initRender(vm)
  // 调用生命周期函数
  callHook(vm, 'beforeCreate')
  // 向 $partent 不断寻找 inject的值，并对inject进行响应化处理
  initInjections(vm) // resolve injections before data/props
  // 核心：响应式
  initState(vm)
  initProvide(vm) // resolve provide after data/props
  callHook(vm, 'created')

  // /* istanbul ignore if */
  // if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
  //   vm._name = formatComponentName(vm, false)
  //   mark(endTag)
  //   measure(`vue ${vm._name} init`, startTag, endTag)
  // }

  if (vm.$options.el) {
    vm.$mount(vm.$options.el)
  }
}
```