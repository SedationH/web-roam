# ä½œç”¨åŸŸæ˜¯ä»€ä¹ˆ

åˆ©ç”¨å˜é‡ è¡¨ç¤º çŠ¶æ€

æ€ä¹ˆæ‰¾åˆ°è¿™äº›å˜é‡ / çŠ¶æ€ï¼Ÿ(è§„åˆ™) -> ä½œç”¨åŸŸ



## ç¼–è¯‘åŸç†

JS éœ€è¦é€šè¿‡JSå¼•æ“è¿›è¡Œç¼–è¯‘



ä¼ ç»Ÿçš„ç¼–è¯‘è¿‡ç¨‹æœ‰ä¸‰ä¸ªæ­¥éª¤

1. è¯æ³•åˆ†æ
   1. å½¢æˆç¼–ç¨‹è¯­è¨€ä¸­çš„æœ€å°å•ä½ token
2. è¯­æ³•åˆ†æ
   1. å°†token å½¢æˆ ASTè¯­æ³•æ ‘ğŸŒ²
3. ä»£ç ç”Ÿæˆ
   1. æ ¹æ®ASTç”Ÿæˆå¯æ‰§è¡Œä»£ç 



ä¼ ç»Ÿçš„è¯­è¨€çš„ç¼–è¯‘è¿‡ç¨‹æ˜¯åœ¨æ„å»ºä¹‹å‰ã€‚

JSçš„å¤§éƒ¨åˆ†ç¼–è¯‘æƒ…å†µå‘ç”Ÿåœ¨ä»£ç æ‰§è¡Œå‰çš„å‡ å¾®ç§’ã€‚æ²¡æœ‰æå‰æ„å»ºçš„è¿‡ç¨‹ï¼ˆä¸æ˜¯æå‰ç¼–è¯‘çš„ï¼‰ï¼Œç¼–è¯‘ç»“æœä¹Ÿä¸èƒ½åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿›è¡Œç§»æ¤ã€‚

> åœ¨æˆ‘ä»¬è®¨è®ºçš„ä½œç”¨åŸŸèƒŒåï¼ŒJSå¼•æ“ç”¨å°½äº†å„ç§åŠæ³•ï¼ˆæ¯”å¦‚JIT just-in-timeï¼Œå¯ä»¥å»¶è¿Ÿç¼–è¯‘ç”šè‡³é‡æ–½ç¼–è¯‘ï¼‰æ¥ä¿è¯æ€§èƒ½æœ€ä½³ã€‚



## ç†è§£ä½œç”¨åŸŸ

å‚ä¸è€…

1. å¼•æ“
   1. ä»å¤´åˆ°å°¾è´Ÿè´£JSç¨‹åºçš„ç¼–è¯‘ä¸æ‰§è¡Œè¿‡ç¨‹
   2. æœ‰ç‚¹åƒæ€»æ§ç¨‹åº
2. ç¼–è¯‘å™¨
   1. è´Ÿè´£è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€ä»£ç ç”Ÿæˆ
3. ä½œç”¨åŸŸ
   1. è´Ÿè´£æ”¶é›†å¹¶ç»´æŠ¤ç”±æ‰€æœ‰å£°æ˜æ ‡è¯†ç¬¦ï¼ˆå˜é‡ï¼‰ç»„æˆçš„ä¸€ç³»åˆ—æŸ¥è¯¢ï¼Œå¹¶å®æ–½ä¸€å¥—éå¸¸ä¸¥æ ¼çš„è§„åˆ™ï¼Œç¡®å®šå½“å‰æ‰§è¡Œçš„ä»£ç å¯¹è¿™äº›æ ‡è¯†ç¬¦çš„è®¿é—®æƒé™ã€‚



`var a = 2`

æœ‰ä¸¤ä¸ªåŠ¨ä½œ

1. ç¼–è¯‘å™¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œçœ‹å½“å‰ä½œç”¨åŸŸæ˜¯å¦å­˜åœ¨aï¼Œè‹¥æ— ï¼Œä¼šåœ¨å½“å‰ä½œç”¨åŸŸä¸­å£°æ˜a
2. å¼•æ“åœ¨æ‰§è¡Œå¯æ‰§è¡Œä»£ç çš„æ—¶å€™åˆ©ç”¨ä½œç”¨åŸŸæŸ¥æ‰¾a



ä¸Šé¢ä¸‰ä½å‚ä¸è€…ä¹‹é—´çš„å…³ç³»

å¼•æ“è´Ÿè´£è°ƒåº¦ç¼–è¯‘å™¨å’Œæ‰§è¡Œä»£ç 



ç¼–è¯‘å™¨åœ¨å·¥ä½œè¿‡ç¨‹ä¸­å®Œå–„ä½œç”¨åŸŸ

å¼•æ“æ‰§è¡Œä»£ç è¿‡ç¨‹ä¸­éœ€è¦ä½œç”¨åŸŸæä¾›æ”¯æŒï¼ˆæŸ¥æ‰¾æ ‡è¯†ç¬¦



æŸ¥æ‰¾æ ‡è¯†ç¬¦çš„æ–¹å¼æœ‰ä¸¤ç§

LHS RHS

> **LHS** is informal shorthand for the **left-hand side** of an [equation](https://en.wikipedia.org/wiki/Equation). Similarly, **RHS** is the **right-hand side**. 

ä»æ•ˆæœä¸Šæ¥çœ‹

- LHSæ˜¯æ‹¿åˆ°å­˜å‚¨å˜é‡çš„å®¹å™¨

- RHSæ˜¯æ‹¿åˆ°å€¼



```js
function foo(a) {
  var b = a;
  return a + b;
}

var c = foo(2)
```

LHS

1. c = ..
2. a = .. (éšå¼)
3. b = ..

RHS

1. foo(2)
2.  = a
3. return a ...
4.  ... + b



## ä½œç”¨åŸŸåµŒå¥—

```js
function foo(a) {
  console.log( a+b )
}

var b = 2

foo(2)
```

b åœ¨è¿›è¡Œ RHS çš„æ—¶å€™éœ€è¦å…¨å±€ä½œç”¨åŸŸä¸­çš„æ ‡è¯†ç¬¦bè¿›è¡Œæ”¯æŒ



fooå‡½æ•°åˆ›å»ºä½œç”¨åŸŸ

fooå£°æ˜åœ¨å…¨å±€ä¸­

åœ¨fooå‡½æ•°ä¸­çš„ä½œç”¨åŸŸæŸ¥è¯¢é“¾

foo scope -> global scope



## å¼‚å¸¸

**åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹**

è€ƒè™‘å¦‚ä¸‹ä»£ç 

```js
function foo(a) {
  console.log( a+b )
  b = a
}

foo(2)
```

å¯¹bè¿›è¡ŒRHSæŸ¥è¯¢çš„æ—¶å€™ã€åœ¨æ•´ä¸ªä½œç”¨åŸŸé“¾ä¸­éƒ½æ— æ³•æ‰¾åˆ°ï¼Œä¼šæœ‰ReferenceError

`Uncaught ReferenceError: b is not defined`



åœ¨å¯¹bè¿›è¡ŒLHSçš„æ—¶å€™ï¼Œç›´åˆ°global scopeä¸­è¿˜æœªå¯»åˆ°ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºç›¸åº”çš„éœ€æ±‚æ ‡è¯†ç¬¦ (å‘ç°ä¹Ÿå’Œä½œç”¨åŸŸè¡¨äº§ç”Ÿäº†åˆ›å»ºçš„äº¤äº’ï¼Œä¸ä»…æ˜¯æŸ¥è¯¢äº†)



# è¯æ³•ä½œç”¨åŸŸ

ä½œç”¨åŸŸç›®å‰å®šä¹‰ä¸ºä¸€ä¸ªè§„åˆ™

è¿™ä¸ªè§„åˆ™ç”¨äºç®¡ç†å¼•æ“åœ¨ä½œç”¨åŸŸé“¾ä¸­å¦‚ä½•æ ¹æ®æ ‡è¯†ç¬¦è¿›è¡Œå˜é‡æŸ¥æ‰¾



ä½œç”¨åŸŸçš„å·¥ä½œæ¨¡å¼æœ‰ä¸¤ç§

- è¯æ³•ä½œç”¨åŸŸ
- åŠ¨æ€ä½œç”¨åŸŸ



## è¯æ³•é˜¶æ®µ

è¯æ³•ä½œç”¨åŸŸè¿™ç§å‘½åæ–¹å¼æºäºç¼–è¯‘çš„ç¬¬ä¸€ä¸ªè¿‡ç¨‹

è¯æ³•åˆ†æ å³ä» æºä»£ç ä¸­æ‹†åˆ†tokençš„è¿‡ç¨‹

> ç®€å•çš„è¯´ï¼Œè¯æ³•ä½œç”¨åŸŸå°±æ˜¯å®šä¹‰åœ¨è¯æ³•é˜¶æ®µçš„ä½œç”¨åŸŸ



## æ¬ºéª—è¯­æ³•

å°±æ˜¯åœ¨è®¨è®ºå¦‚ä½•åœ¨è¿è¡Œæ—¶å½±å“ä½œç”¨åŸŸ

> JSä¸­æœ‰ä¸¤ç§æœºåˆ¶æ¥å®ç°è¿™ä¸ªç›®çš„ï¼Œç¤¾åŒºæ™®éè®¤è¯†ä¸ºä¸è¦ä½¿ç”¨ï¼Œä¾¿åˆ©å¸¦æ¥çš„æ”¶ç›Šä¸æŠµæ€§èƒ½ä¸‹é™å¸¦æ¥çš„æŸè€—



1. eval

åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹

`eval(agr: stirng)`

argè¡¨ç°ä¸ºå¥½åƒåŸæ¥ä»£ç å°±å†™åœ¨é‚£é‡Œä¸€æ ·

```js
function foo(evalString) {
  eval(evalString)
  console.log(b)
  b = 'in foo'
  console.log(b)
}
var b = 'global'
foo('var b = "in eval || foo"')
console.log(b)

// in eval || foo
// in foo
// global
```

åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹

```js
function foo(evalString) {
  'use strict'
  eval(evalString)
  console.log(b)
  b = 'in foo'
  console.log(b)
}
var b = 'global'
foo('var b = "in eval || foo"')
console.log(b)

// global
// in foo
// in foo
```

ä¸¥æ ¼æ¨¡å¼ä¸‹ evalæœ‰è‡ªå·±çš„ä½œç”¨åŸŸï¼Œä¸ä¼šå½±å“å¤–ç•Œ

2. with

```js
var a
function foo(obj) {
  with (obj) {
    a = 1
  }
}

const o1 = { a: 2 }
const o2 = { b: 2 }

console.log(a, o1.a)
foo(o1)
console.log(a, o1.a)

console.log(a, o2.a)
foo(o2)
console.log(a, o2.a)
// undefined 2
// undefined 1
// undefined undefined
// 1 undefined
```

è¿›è¡Œä¿®æ”¹

```js
var a
function foo(obj) {
  var a
  with (obj) {
    a = 1
    var bar = 'bar'
    try {
      console.log('in with RHS', b)
    } catch (error) {
      console.log('cant find b when obj is ', JSON.stringify(obj))
    }
  }
  console.log(obj) // {a: 1} || {b: 2}
}

const o1 = { a: 2 }
const o2 = { b: 2 }

console.log(a, o1.a)
foo(o1)
console.log(a, o1.a)

console.log(a, o2.a)
foo(o2)
console.log(a, o2.a)
```



è¿™ä¸ªä¾‹å­å¯ä»¥æŠŠwithçš„æœºåˆ¶çœ‹çš„æ›´åŠ æ¸…æ™°

å¯¹äº`with`ä¸­çš„ä»£ç ï¼Œåœ¨å…¶è¿›è¡ŒRHS && LHSå¯»æ±‚å€¼ã€å®¹å™¨çš„æ—¶å€™ï¼Œåœ¨åŸæœ‰çš„ä½œç”¨åŸŸé“¾ä¸ŠåŠ äº†ä¸€å±‚obj

ä»è¿™ä¸ªæœºåˆ¶ä¸Šæ¥çœ‹ï¼Œå¯ä»¥ç”¨ç±»ä¼¼objectçš„æ–¹å¼æ¥å®ç°å¯¹ä½œç”¨åŸŸçš„ç»„ç»‡

å…¶ä»–çš„åŸºæœ¬åŸç†å’Œè¾¹ç•Œæƒ…å†µä¸æ­£å¸¸RHS && LHSæƒ…å†µä¸€è‡´



æœ‰è¶£çš„æ˜¯ï¼Œ`var bar = 'bar'`æ˜¯å£°æ˜è¯­å¥ï¼Œä½†æ•ˆæœä¸Šå¹¶æ²¡æœ‰åœ¨objä¸Šæ·»åŠ barï¼Œä»å£°æ˜åˆ›å»ºçš„è§’åº¦æ¥çœ‹ï¼Œåº”æ˜¯åœ¨å½“å‰scopeåˆ›å»ºæ ‡è¯†ç¬¦ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆçš„ï¼Œè€Œå¯¹äºwithçš„æ•ˆæœäº§ç”Ÿäºæ‰§è¡Œæ—¶ï¼Œæ²¡åŠæ³•ï¼Œä¹Ÿä¸åº”è¯¥èƒ½åœ¨objä¸Šé€šè¿‡var å£°æ˜æ¥æŒ‚å¯¹è±¡

(æˆ‘æ„Ÿè§‰è‡ªå·±æ¯”ä¹¦æœ¬ä¸Šè¯´çš„è¦æ¸…æ¥šğŸ˜„)



## æ€§èƒ½

ä¸ºå•¥ç”¨with evalä¼šå½±å“æ€§èƒ½ï¼Ÿ

å› ä¸ºç¼–è¯‘å™¨è¿›è¡Œçš„ä¼˜åŒ–å¤§å¤šä¾èµ–äºè¯æ³•é™æ€åˆ†æ



# å‡½æ•°ä½œç”¨åŸŸå’Œå—ä½œç”¨åŸŸ



